name: Bootstrap TLDR (Linux only)

permissions:
  contents: write

on:
  workflow_dispatch: {}   # ручной запуск из Actions

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare directories
        run: |
          set -euxo pipefail
          mkdir -p vendor/tldr/pages/linux .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

      - name: Download TLDR (Linux pages only)
        run: |
          set -euxo pipefail
          curl -fsSL https://tldr.sh/assets/tldr.zip -o /tmp/tldr.zip
          unzip -o /tmp/tldr.zip -d /tmp/tldr
          rsync -a --delete /tmp/tldr/pages/linux/ vendor/tldr/pages/linux/

      - name: Verify downloaded files
        run: |
          echo "Preview first 10 pages:"
          ls -la vendor/tldr/pages/linux | head
          echo "Total count:"
          find vendor/tldr/pages/linux -type f | wc -l

      - name: Build list of files
        run: |
          find vendor/tldr/pages/linux -type f -name '*.md' > .state/files.list
          echo "Total pages: $(wc -l < .state/files.list)"

      - name: Commit & push to main
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          set -euxo pipefail
          git config user.name  "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"
          git add vendor/tldr/pages/linux .state/files.list
          git commit -m "chore: import TLDR Linux pages" || echo "Nothing new to commit"
          BRANCH=${GITHUB_REF_NAME:-main}
          git fetch origin $BRANCH
          git pull --rebase origin $BRANCH || true
          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:$BRANCH
