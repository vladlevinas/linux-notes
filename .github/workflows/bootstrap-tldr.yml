name: Bootstrap TLDR vendor

permissions:
  contents: write

on:
  workflow_dispatch: {}   # запуск вручную из Actions

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # важный параметр

      - name: Prepare dirs
        run: |
          mkdir -p vendor/tldr .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

      - name: Download TLDR archive
        run: |
          curl -fsSL https://tldr.sh/assets/tldr.zip -o /tmp/tldr.zip
          unzip -o /tmp/tldr.zip -d /tmp/tldr
          rsync -a --delete /tmp/tldr/pages/linux/  vendor/tldr/pages/linux/  || true
          rsync -a --delete /tmp/tldr/pages/common/ vendor/tldr/pages/common/ || true

      - name: Build deterministic file list
        run: |
          find vendor/tldr/pages/common -type f -name '*.md' > /tmp/all.txt || true
          find vendor/tldr/pages/linux  -type f -name '*.md' >> /tmp/all.txt || true
          awk -F/ '{print $NF "|" $0}' /tmp/all.txt | sort -f | cut -d"|" -f2 > .state/files.list
          echo "Total files: $(wc -l < .state/files.list)"

      - name: Commit & push vendor + list
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          git config user.name "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"

          git add vendor/tldr .state/files.list
          git commit -m "chore: bootstrap TLDR vendor & file list" || echo "Nothing new to commit"

          BRANCH=${GITHUB_REF_NAME:-main}
          git fetch origin $BRANCH
          git pull --rebase origin $BRANCH

          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:$BRANCH
