name: Bootstrap TLDR vendor

permissions:
  contents: write

on:
  workflow_dispatch: {}   # запускается вручную из Actions

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare dirs
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p vendor/tldr .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

      - name: Download TLDR archive
        shell: bash
        run: |
          set -euxo pipefail
          curl -fsSL https://tldr.sh/assets/tldr.zip -o /tmp/tldr.zip
          unzip -o /tmp/tldr.zip -d /tmp/tldr
          mkdir -p vendor/tldr/pages/linux vendor/tldr/pages/common
          cp -R /tmp/tldr/pages/linux/*  vendor/tldr/pages/linux/  || true
          cp -R /tmp/tldr/pages/common/* vendor/tldr/pages/common/ || true

      - name: Verify files exist (debug)
        shell: bash
        run: |
          set -euxo pipefail
          ls -la vendor/tldr/pages/linux  | head || true
          ls -la vendor/tldr/pages/common | head || true

      - name: Build deterministic file list
        shell: bash
        run: |
          set -euxo pipefail
          find vendor/tldr/pages/common -type f -name '*.md' > /tmp/all.txt || true
          find vendor/tldr/pages/linux  -type f -name '*.md' >> /tmp/all.txt || true
          awk -F/ '{print $NF "|" $0}' /tmp/all.txt | sort -f | cut -d"|" -f2 > .state/files.list
          echo "Total files: $(wc -l < .state/files.list)"

      - name: Commit & push to main
        env:
          GH_TOKEN: ${{ secrets.PAT }}   # см. примечание ниже
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name  "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"
          git add vendor/tldr .state/files.list
          git commit -m "chore: bootstrap TLDR vendor & file list" || echo "Nothing new to commit"
          BRANCH=${GITHUB_REF_NAME:-main}
          git fetch origin $BRANCH
          git pull --rebase origin $BRANCH || true
          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:$BRANCH
