name: TLDR â†’ Notes (3x daily, Linux + Common)

permissions:
  contents: write

on:
  schedule:
    # 09:00, 15:00, 21:00 Ð¿Ð¾ Ð’Ð¸Ð»ÑŒÐ½ÑŽÑÑƒ (â‰ˆ 07:00, 13:00, 19:00 UTC)
    - cron: "0 7,13,19 * * *"
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure state and file list
        run: |
          set -eux
          mkdir -p .state notes
          if [ ! -f .state/idx ]; then echo 1 > .state/idx; fi

          if [ ! -s .state/files.list ]; then
            echo "Building TLDR list..."
            find vendor/tldr/pages/linux  -type f -name '*.md' > /tmp/linux.txt  || true
            find vendor/tldr/pages/common -type f -name '*.md' > /tmp/common.txt || true
            cat /tmp/linux.txt /tmp/common.txt | awk -F/ '{print $NF "|" $0}' | sort -f | cut -d"|" -f2 > .state/files.list
            echo "Total TLDR files: $(wc -l < .state/files.list)"
          fi

      - name: Pick next TLDR page
        id: pick
        shell: bash
        run: |
          set -eux
          IDX=$(tr -d '\r' < .state/idx)
          TOTAL=$(wc -l < .state/files.list | tr -d ' ')
          if [ "$IDX" -gt "$TOTAL" ]; then IDX=1; fi

          SRC=$(sed -n "${IDX}p" .state/files.list)
          BASENAME=$(basename "$SRC")
          NAME="${BASENAME%.md}"
          DEST="notes/${NAME}.md"

          echo "# ${NAME}" > "$DEST"
          echo "" >> "$DEST"
          echo "> Source: TLDR (MIT) â€” from 'vendor/tldr/'" >> "$DEST"
          echo "" >> "$DEST"
          cat "$SRC" >> "$DEST"
          echo "" >> "$DEST"
          echo "---" >> "$DEST"
          date -u +"_Imported: %Y-%m-%d %H:%M:%S UTC_" >> "$DEST"

          # Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¼ ÑÐ¿Ð¾ÑÐ¾Ð±Ð¾Ð¼
          IDX_NEXT=$(expr "$IDX" + 1)
          echo "$IDX_NEXT" > .state/idx

          {
            echo "# ðŸ“˜ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¼ÐµÑ‚Ð¾Ðº Ð¿Ð¾ Linux-ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼"
            echo
            COUNT=0
            for f in notes/*.md; do
              TITLE=$(head -n1 "$f" | sed 's/^# //')
              COUNT=$(expr "$COUNT" + 1)
              FILE=$(basename "$f")
              echo "- [$COUNT. $TITLE](notes/$FILE)"
            done | sort -f
            echo
            date -u +"_Last updated: %Y-%m-%d %H:%M:%S UTC_"
          } > README.md

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "index=$IDX_NEXT" >> $GITHUB_OUTPUT

      - name: Commit & push
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          set -eux
          git config user.name "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"
          git add .state/idx notes/ README.md
          git commit -m "ðŸ•’ TLDR note #${{ steps.pick.outputs.index }} of ${{ steps.pick.outputs.total }} â€” '${{ steps.pick.outputs.name }}'" || echo "Nothing new to commit"
          git pull --rebase origin main || true
          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:main
