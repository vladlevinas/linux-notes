name: TLDR → Notes (3x daily, Linux + Common)

permissions:
  contents: write

on:
  schedule:
    # 09:00, 15:00, 21:00 по Вильнюсу ≈ 07:00, 13:00, 19:00 UTC
    - cron: "0 7,13,19 * * *"
  workflow_dispatch: {}  # можно запустить вручную

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure state and build file list
        run: |
          set -euxo pipefail
          mkdir -p .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

          if [ ! -s .state/files.list ]; then
            echo "Building combined file list..."
            find vendor/tldr/pages/linux  -type f -name '*.md' > /tmp/linux.txt  || true
            find vendor/tldr/pages/common -type f -name '*.md' > /tmp/common.txt || true
            cat /tmp/linux.txt /tmp/common.txt | awk -F/ '{print $NF "|" $0}' | sort -f | cut -d"|" -f2 > .state/files.list
            echo "File list created: $(wc -l < .state/files.list) files"
          fi

      - name: Pick next TLDR page
        id: pick
        shell: bash
        run: |
          set -euxo pipefail

          IDX=$(tr -d '\r' < .state/idx)
          TOTAL=$(wc -l < .state/files.list | tr -d ' ')
          if [ "$IDX" -gt "$TOTAL" ]; then
            IDX=1
          fi

          SRC=$(sed -n "${IDX}p" .state/files.list)
          BASENAME=$(basename "$SRC")
          NAME="${BASENAME%.
