name: TLDR â†’ Notes (3x daily, Linux + Common)

permissions:
  contents: write

on:
  schedule:
    # Ð’Ñ€ÐµÐ¼Ñ UTC â€” Ð´Ð»Ñ Ð’Ð¸Ð»ÑŒÐ½ÑŽÑÐ° (UTC+2 Ð·Ð¸Ð¼Ð¾Ð¹, +3 Ð»ÐµÑ‚Ð¾Ð¼)
    # Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ 09:00, 15:00, 21:00 Ð’Ð¸Ð»ÑŒÐ½ÑŽÑ = 07:00, 13:00, 19:00 UTC
    - cron: "0 7,13,19 * * *"
  workflow_dispatch: {}  # Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure state and file list
        run: |
          set -euxo pipefail
          mkdir -p .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

          # ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ ÑÐ¿Ð¸ÑÐºÐ°, ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½Ñ‘Ð½Ð½Ñ‹Ð¹ (linux + common)
          if [ ! -s .state/files.list ]; then
            echo "Building combined file list..."
            find vendor/tldr/pages/linux  -type f -name '*.md' > /tmp/linux.txt  || true
            find vendor/tldr/pages/common -type f -name '*.md' > /tmp/common.txt || true
            cat /tmp/linux.txt /tmp/common.txt | awk -F/ '{print $NF "|" $0}' | sort -f | cut -d"|" -f2 > .state/files.list
          fi

      - name: Pick next page
        id: pick
        shell: bash
        run: |
          set -euxo pipefail
          IDX=$(tr -d '\r' < .state/idx)
          TOTAL=$(wc -l < .state/files.list | tr -d ' ')
          if [ "$IDX" -gt "$TOTAL" ]; then
            IDX=1
          fi

          SRC=$(sed -n "${IDX}p" .state/files.list)
          BASENAME=$(basename "$SRC")          # ls.md
          NAME="${BASENAME%.md}"               # ls
          DEST="notes/${NAME}.md"

          {
            echo "# ${NAME}"
            echo
            echo "> Source: TLDR (MIT) â€” from \`vendor/tldr/\`"
            echo
            cat "$SRC"
            echo
            echo "---"
            echo "_Imported: $(date -u +'%Y-%m-%d %H:%M:%S') UTC_"
          } > "$DEST"

          NEXT=$((IDX + 1))
          echo "$NEXT" > .state/idx

          # ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸Ð½Ð´ÐµÐºÑ Ð·Ð°Ð¼ÐµÑ‚Ð¾Ðº
          {
            echo "# Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¼ÐµÑ‚Ð¾Ðº Ð¿Ð¾ Linux-ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼"
            echo
            COUNT=0
            for f in notes/*.md; do
              TITLE=$(head -n1 "$f" | sed 's/^# //')
              COUNT=$((COUNT + 1))
              echo "- [$COUNT. $TITLE]($f)"
            done | sort -f
            echo
            echo "_Last updated: $(date -u +'%Y-%m-%d %H:%M:%S') UTC_"
          } > notes/README.md

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "index=$IDX"  >> $GITHUB_OUTPUT

      - name: Commit & push
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          set -euxo pipefail
          git config user.name "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"
          git add .state/idx notes/
          git commit -m "ðŸ•’ TLDR note #${{ steps.pick.outputs.index }} of ${{ steps.pick.outputs.total }} â€” '${{ steps.pick.outputs.name }}'" || echo "Nothing new to commit"
          BRANCH=${GITHUB_REF_NAME:-main}
          git fetch origin $BRANCH
          git pull --rebase origin $BRANCH || true
          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:$BRANCH
