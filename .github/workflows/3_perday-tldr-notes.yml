name: TLDR â†’ Notes (3x daily, Linux + Common)

permissions:
  contents: write

on:
  schedule:
    # 09:00, 15:00, 21:00 Ð’Ð¸Ð»ÑŒÐ½ÑŽÑ (â‰ˆ 07:00, 13:00, 19:00 UTC)
    - cron: "0 7,13,19 * * *"
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure state and list
        run: |
          set -euxo pipefail
          mkdir -p .state notes
          [ -f .state/idx ] || echo 1 > .state/idx

          if [ ! -s .state/files.list ]; then
            echo "Building TLDR list..."
            find vendor/tldr/pages/linux  -type f -name '*.md' > /tmp/linux.txt  || true
            find vendor/tldr/pages/common -type f -name '*.md' > /tmp/common.txt || true
            cat /tmp/linux.txt /tmp/common.txt | awk -F/ '{print $NF "|" $0}' | sort -f | cut -d"|" -f2 > .state/files.list
          fi

      - name: Pick next TLDR page
        id: pick
        run: bash .github/scripts/pick-note.sh

      - name: Commit & push
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          set -euxo pipefail
          git config user.name "Vlad Levinas"
          git config user.email "vladimir@dbits.lt"
          git add .state/idx notes/ README.md
          git commit -m "ðŸ•’ TLDR note update" || echo "Nothing new to commit"
          git pull --rebase origin main || true
          git push https://$GH_TOKEN@github.com/${{ github.repository }} HEAD:main
